{
  "rules": {
    "sessions": {
      "$sessionId": {
        // Anyone can read session data (needed for participants to see their assignments)
        ".read": true,

        // Only allow creating new sessions (one-time write)
        ".write": "!data.exists()",

        // Session metadata (name, status, createdBy, createdAt)
        "name": {
          ".validate": "newData.isString()"
        },
        "status": {
          ".write": "data.parent().child('adminKey').val() === root.child('sessions').child($sessionId).child('adminKey').val()",
          ".validate": "newData.val() === 'setup' || newData.val() === 'drawing' || newData.val() === 'completed'"
        },
        "createdBy": {
          ".validate": "newData.isString()"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "adminKey": {
          ".validate": "newData.isString()"
        },

        // Participants can be added by anyone (so family members can join)
        "participants": {
          ".write": true,
          "$participantId": {
            ".validate": "newData.hasChildren(['name', 'hasDrawn', 'isExcluded', 'joinedAt'])",
            "name": {
              ".validate": "newData.isString()"
            },
            "hasDrawn": {
              ".validate": "newData.isBoolean()"
            },
            "isExcluded": {
              ".validate": "newData.isBoolean()"
            },
            "joinedAt": {
              ".validate": "newData.isNumber()"
            }
          }
        },

        // Assignments can only be written by organizer (with admin key verification)
        // This is the critical security rule - prevents cheating!
        "assignments": {
          ".write": "!data.exists() && root.child('sessions').child($sessionId).child('adminKey').val() != null",
          "$participantName": {
            ".validate": "newData.isString()"
          }
        },

        // Restrictions can be set by anyone (organizer manages via UI)
        "restrictions": {
          ".write": true,
          "$participantName": {
            ".validate": "newData.hasChildren()"
          }
        }
      }
    }
  }
}
